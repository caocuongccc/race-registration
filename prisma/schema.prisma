generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  name          String?
  role          UserRole       @default(ADMIN)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  eventUsers    EventUser[]
  events        Event[]
  importBatches ImportBatch[]
  registrations Registration[]

  @@map("users")
}

model Event {
  id                   String         @id @default(cuid())
  name                 String
  slug                 String         @unique
  description          String?
  date                 DateTime
  location             String
  address              String?
  city                 String?
  status               EventStatus    @default(DRAFT)
  isPublished          Boolean        @default(false)
  allowRegistration    Boolean        @default(false)
  racePackLocation     String?
  racePackTime         String?
  racePackSchedule     String?
  raceDaySchedule      String?
  parkingInfo          String?
  checkinProcedure     String?
  hotline              String?
  emailSupport         String?
  facebookUrl          String?
  websiteUrl           String?
  logoUrl              String?
  bannerUrl            String?
  coverImageUrl        String?
  hasShirt             Boolean        @default(false)
  requireOnlinePayment Boolean        @default(true)
  sendBibImmediately   Boolean        @default(true)
  bankName             String?
  bankAccount          String?
  bankHolder           String?
  bankCode             String?
  createdById          String
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  distances            Distance[]
  emailConfig          EmailConfig?
  eventImages          EventImage[]
  shirts               EventShirt[]
  assignedUsers        EventUser[]
  createdBy            User           @relation(fields: [createdById], references: [id])
  importBatches        ImportBatch[]
  registrations        Registration[]
  shirtOrders          ShirtOrder[]

  @@map("events")
}

model EventImage {
  id                 String         @id @default(cuid())
  eventId            String
  imageUrl           String
  cloudinaryPublicId String?
  imageType          EventImageType
  title              String?
  description        String?
  sortOrder          Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  event              Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, imageType])
  @@map("event_images")
}

model Distance {
  id                  String         @id @default(cuid())
  eventId             String
  name                String
  price               Int
  bibPrefix           String
  maxParticipants     Int?
  currentParticipants Int            @default(0)
  isAvailable         Boolean        @default(true)
  sortOrder           Int            @default(0)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  hasGoals            Boolean        @default(false)
  distanceGoals       DistanceGoal[]
  event               Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrations       Registration[]

  @@unique([eventId, name])
  @@map("distances")
}

model DistanceGoal {
  id                  String         @id @default(cuid())
  distanceId          String
  name                String
  description         String?
  targetTime          Int?
  bibPrefix           String
  maxParticipants     Int?
  currentParticipants Int            @default(0)
  priceAdjustment     Int            @default(0)
  isAvailable         Boolean        @default(true)
  sortOrder           Int            @default(0)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  distance            Distance       @relation(fields: [distanceId], references: [id], onDelete: Cascade)
  registrations       Registration[]

  @@unique([distanceId, name])
  @@index([distanceId, isAvailable])
  @@map("distance_goals")
}

model EventShirt {
  id                 String           @id @default(cuid())
  eventId            String
  category           ShirtCategory
  type               ShirtType
  size               ShirtSize
  price              Int
  stockQuantity      Int
  soldQuantity       Int              @default(0)
  isAvailable        Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  previewImageUrl    String?
  cloudinaryPublicId String?
  standalonePrice    Int?
  event              Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrations      Registration[]
  shirtOrders        ShirtOrderItem[]

  @@unique([eventId, category, type, size])
  @@index([eventId, isAvailable])
  @@map("event_shirts")
}

model Registration {
  id                    String              @id @default(cuid())
  eventId               String
  distanceId            String
  shirtId               String?
  fullName              String
  email                 String
  phone                 String
  dob                   DateTime
  gender                Gender
  idCard                String?
  address               String?
  city                  String?
  emergencyContactName  String?
  emergencyContactPhone String?
  healthDeclaration     Boolean             @default(false)
  bloodType             String?
  shirtCategory         ShirtCategory?
  shirtType             ShirtType?
  shirtSize             ShirtSize?
  raceFee               Int
  shirtFee              Int                 @default(0)
  totalAmount           Int
  paymentStatus         PaymentStatus       @default(PENDING)
  bibNumber             String?             @unique
  qrPaymentUrl          String?
  qrCheckinUrl          String?
  confirmationToken     String?             @unique
  utmSource             String?
  notes                 String?
  registrationDate      DateTime            @default(now())
  paymentDate           DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  userId                String?
  registrationSource    RegistrationSource? @default(ONLINE)
  importBatchId         String?
  distanceGoalId        String?
  emailLogs             EmailLog[]
  payments              Payment[]
  distanceGoal          DistanceGoal?       @relation(fields: [distanceGoalId], references: [id])
  distance              Distance            @relation(fields: [distanceId], references: [id])
  event                 Event               @relation(fields: [eventId], references: [id])
  importBatch           ImportBatch?        @relation(fields: [importBatchId], references: [id])
  shirt                 EventShirt?         @relation(fields: [shirtId], references: [id])
  user                  User?               @relation(fields: [userId], references: [id])
  shirtOrders           ShirtOrder[]

  @@index([importBatchId])
  @@index([eventId, paymentStatus])
  @@index([distanceId])
  @@index([distanceGoalId])
  @@index([email])
  @@map("registrations")
}

model Payment {
  id             String        @id @default(cuid())
  registrationId String
  transactionId  String?       @unique
  amount         Int
  status         PaymentStatus @default(PENDING)
  paymentMethod  String?
  webhookData    Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  registration   Registration  @relation(fields: [registrationId], references: [id])

  @@index([registrationId])
  @@map("payments")
}

model EmailConfig {
  id                          String   @id @default(cuid())
  eventId                     String   @unique
  fromName                    String
  fromEmail                   String
  replyTo                     String?
  useGmailFallback            Boolean  @default(false)
  gmailUser                   String?
  gmailAppPassword            String?
  subjectRegistrationPending  String   @default("Xác nhận đăng ký - {{eventName}}")
  subjectPaymentConfirmed     String   @default("Thanh toán thành công - Số BIB {{bibNumber}}")
  subjectPaymentReceivedNoBib String   @default("Đã nhận thanh toán - {{eventName}}")
  subjectBibAnnouncement      String   @default("Thông báo số BIB - {{eventName}}")
  subjectRacePackInfo         String   @default("Thông tin quan trọng - {{eventName}}")
  subjectReminder             String   @default("Nhắc nhở - {{eventName}}")
  bodyRegistrationPending     String
  bodyPaymentConfirmed        String
  bodyPaymentReceivedNoBib    String
  bodyBibAnnouncement         String
  bodyRacePackInfo            String
  bodyReminder                String
  attachQrPayment             Boolean  @default(true)
  attachQrCheckin             Boolean  @default(true)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
  subjectShirtOrder           String?  @default("Xác nhận đơn hàng áo - {{eventName}}")
  bodyShirtOrder              String?  @default("Đơn hàng áo của bạn đã được xác nhận")
  event                       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("email_configs")
}

model EmailLog {
  id             String       @id @default(cuid())
  registrationId String
  emailType      EmailType
  subject        String?
  sentAt         DateTime     @default(now())
  status         EmailStatus  @default(SENT)
  errorMessage   String?
  resendCount    Int          @default(0)
  bibNumber      String?
  emailProvider  String?
  recipientEmail String
  registration   Registration @relation(fields: [registrationId], references: [id])

  @@index([registrationId, emailType])
  @@index([bibNumber])
  @@index([recipientEmail])
  @@index([emailProvider, status])
  @@map("email_logs")
}

model ImportBatch {
  id             String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  eventId        String
  fileName       String
  uploadedBy     String
  totalRows      Int
  successCount   Int            @default(0)
  failedCount    Int            @default(0)
  status         ImportStatus   @default(PROCESSING)
  errorLog       Json?
  createdAt      DateTime       @default(now())
  completedAt    DateTime?
  event          Event          @relation(fields: [eventId], references: [id])
  uploadedByUser User           @relation(fields: [uploadedBy], references: [id])
  registrations  Registration[]

  @@map("import_batches")
}

model ShirtOrder {
  id             String           @id @default(cuid())
  registrationId String?
  eventId        String
  orderType      ShirtOrderType   @default(WITH_BIB)
  totalAmount    Int
  paymentStatus  PaymentStatus    @default(PENDING)
  paymentDate    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  email          String?
  items          ShirtOrderItem[]
  event          Event            @relation(fields: [eventId], references: [id])
  registration   Registration?    @relation(fields: [registrationId], references: [id])

  @@index([eventId, paymentStatus])
  @@index([registrationId])
  @@map("shirt_orders")
}

model ShirtOrderItem {
  id         String     @id @default(cuid())
  orderId    String
  shirtId    String
  quantity   Int        @default(1)
  unitPrice  Int
  totalPrice Int
  createdAt  DateTime   @default(now())
  order      ShirtOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shirt      EventShirt @relation(fields: [shirtId], references: [id])

  @@index([orderId])
  @@index([shirtId])
  @@map("shirt_order_items")
}

model EventUser {
  id        String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  eventId   String
  userId    String
  role      EventUserRole @default(VIEWER)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt
  event     Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
  @@index([role])
  @@map("event_users")
}

enum ShirtOrderType {
  WITH_BIB
  STANDALONE
}

enum UserRole {
  ADMIN
  ORGANIZER
  MEMBER
}

enum EventImageType {
  BANNER
  COVER
  GALLERY
  SHIRT_MALE
  SHIRT_FEMALE
  SHIRT_KID
  VENUE
  COURSE_MAP
}

enum EventStatus {
  DRAFT
  PUBLISHED
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  COMPLETED
  CANCELLED
}

enum ShirtCategory {
  MALE
  FEMALE
  KID
}

enum ShirtType {
  SHORT_SLEEVE
  TANK_TOP
}

enum ShirtSize {
  XS
  S
  M
  L
  XL
  XXL
  XXXL
}

enum RegistrationSource {
  ONLINE
  EXCEL
  MANUAL
}

enum Gender {
  MALE
  FEMALE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ImportStatus {
  PROCESSING
  COMPLETED
  FAILED
  PARTIAL
}

enum EmailType {
  REGISTRATION_PENDING
  PAYMENT_CONFIRMED
  PAYMENT_RECEIVED_NO_BIB
  BIB_ANNOUNCEMENT
  RACE_PACK_INFO
  REMINDER
  CUSTOM
}

enum EmailStatus {
  SENT
  DELIVERED
  OPENED
  FAILED
  BOUNCED
}

enum EventUserRole {
  ADMIN
  EDITOR
  VIEWER
}
